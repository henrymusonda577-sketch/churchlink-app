import 'package:flutter/material.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:intl/intl.dart';
import 'services/post_service.dart';
import 'services/user_service.dart';
import 'services/verse_service.dart';
import 'services/church_service.dart';
import 'create_post_screen.dart';
import 'facebook_profile_screen.dart';
import 'content_screen.dart';
import 'chat_screen.dart';
import 'community_screen.dart';
import 'church_group_chat_page.dart';
import 'pastor_dashboard.dart';
import 'notifications_screen.dart';
import 'settings_screen.dart';
import 'story_viewer_screen.dart';
import 'bible_screen.dart';
import 'widgets/online_status_indicator.dart';
import 'widgets/feed_video_player.dart';
import 'donate_screen.dart';

class FacebookHomeScreen extends StatefulWidget {
  final Map<String, String> userInfo;
  final bool forceRegularScreen;

  const FacebookHomeScreen({
    super.key,
    required this.userInfo,
    this.forceRegularScreen = false,
  });

  @override
  State<FacebookHomeScreen> createState() => _FacebookHomeScreenState();
}

class _FacebookHomeScreenState extends State<FacebookHomeScreen> {
  final PostService _postService = PostService();
  final UserService _userService = UserService();
  final VerseService _verseService = VerseService();
  final FirebaseAuth _auth = FirebaseAuth.instance;
  int _selectedIndex = 0;
  late bool isPastor;
  int _contentInitialTab = 0; // Track initial tab for ContentScreen

  // Church membership state
  String? _userChurchId;
  String? _userChurchName;
  bool _isLoadingChurchInfo = true;

  @override
  void initState() {
    super.initState();
    _loadChurchMembership();
  }

  Future<void> _loadChurchMembership() async {
    try {
      final user = _auth.currentUser;
      if (user != null) {
        final userDoc = await FirebaseFirestore.instance
            .collection('users')
            .doc(user.uid)
            .get();

        if (userDoc.exists) {
          final userData = userDoc.data()!;
          setState(() {
            _userChurchId = userData['churchId'];
            _userChurchName = userData['churchName'];
            _isLoadingChurchInfo = false;
          });
        } else {
          setState(() {
            _isLoadingChurchInfo = false;
          });
        }
      } else {
        setState(() {
          _isLoadingChurchInfo = false;
        });
      }
    } catch (e) {
      print('Error loading church membership: $e');
      setState(() {
        _isLoadingChurchInfo = false;
      });
    }
  }

  void _onItemTapped(int index) {
    setState(() {
      _selectedIndex = index;
    });
  }

  @override
  Widget build(BuildContext context) {
    // Check if user is a pastor (case-insensitive)
    isPastor = widget.userInfo['role']?.toLowerCase() == 'pastor';

    // Always show regular home screen - pastors get a dashboard button
    return Scaffold(
      backgroundColor: Colors.grey[100],
      appBar: _buildAppBar(),
      body: IndexedStack(
        index: _selectedIndex,
        children: [
          _buildHomeTab(),
          ContentScreen(
              userInfo: widget.userInfo,
              initialTab: _contentInitialTab,
              key: ValueKey(_contentInitialTab)),
          BibleScreen(),
          ChatScreen(userInfo: widget.userInfo),
          CommunityScreen(userInfo: widget.userInfo),
          DonateScreen(userInfo: widget.userInfo),
        ],
      ),
      bottomNavigationBar: BottomNavigationBar(
        items: const <BottomNavigationBarItem>[
          BottomNavigationBarItem(
            icon: Icon(Icons.home),
            label: 'Home',
          ),
          BottomNavigationBarItem(
            icon: Icon(Icons.video_library),
            label: 'Content',
          ),
          BottomNavigationBarItem(
            icon: Icon(Icons.menu_book),
            label: 'Bible',
          ),
          BottomNavigationBarItem(
            icon: Icon(Icons.message),
            label: 'Messaging',
          ),
          BottomNavigationBarItem(
            icon: Icon(Icons.people),
            label: 'Community',
          ),
          BottomNavigationBarItem(
            icon: Icon(Icons.volunteer_activism),
            label: 'Donations',
          ),
        ],
        currentIndex: _selectedIndex,
        selectedItemColor: const Color(0xFF1E3A8A),
        unselectedItemColor: Colors.grey,
        onTap: _onItemTapped,
      ),
      floatingActionButton: _selectedIndex == 0
          ? FloatingActionButton(
              heroTag: 'facebook_home_fab',
              onPressed: () => _navigateToCreatePost(isStory: false),
              backgroundColor: const Color(0xFF1E3A8A),
              child: const Icon(Icons.add, color: Colors.white),
            )
          : null,
    );
  }

  Widget _buildHomeTab() {
    return RefreshIndicator(
      onRefresh: () async {
        setState(() {});
      },
      child: SingleChildScrollView(
        child: Column(
          children: [
            _buildVerseOfTheDaySection(),
            _buildStoriesSection(),
            _buildCreatePostSection(),
            _buildPostsFeed(),
          ],
        ),
      ),
    );
  }

  PreferredSizeWidget _buildAppBar() {
    return AppBar(
      backgroundColor: const Color(0xFF1E3A8A),
      foregroundColor: Colors.white,
      title: const Text(
        'All Churches',
        style: TextStyle(fontWeight: FontWeight.bold),
      ),
      actions: [
        // Show dashboard button for pastors
        if (isPastor)
          IconButton(
            icon: const Icon(Icons.dashboard),
            tooltip: 'Pastor Dashboard',
            onPressed: () {
              Navigator.of(context).push(
                MaterialPageRoute(
                  builder: (context) =>
                      PastorDashboard(userInfo: widget.userInfo),
                ),
              );
            },
          ),
        // Show church icon if user has joined a church - positioned close to notifications
        if (!_isLoadingChurchInfo &&
            _userChurchId != null &&
            _userChurchId!.isNotEmpty)
          IconButton(
            icon: const Icon(Icons.church),
            tooltip: 'Church Group Chat',
            onPressed: () {
              // Navigate to church group chat page
              Navigator.of(context).push(
                MaterialPageRoute(
                  builder: (context) => ChurchGroupChatPage(
                    churchId: _userChurchId!,
                    churchName: _userChurchName ?? 'Church',
                  ),
                ),
              );
            },
          ),
        IconButton(
          icon: const Icon(Icons.notifications),
          onPressed: () {
            Navigator.of(context).push(
              MaterialPageRoute(
                builder: (context) =>
                    NotificationsScreen(userInfo: widget.userInfo),
              ),
            );
          },
        ),
        IconButton(
          icon: const Icon(Icons.search),
          onPressed: () {
            showSearch(
              context: context,
              delegate: _ChurchSearchDelegate(userInfo: widget.userInfo),
            );
          },
        ),
        IconButton(
          icon: const Icon(Icons.settings),
          tooltip: 'Settings',
          onPressed: () {
            Navigator.of(context).push(
              MaterialPageRoute(
                builder: (context) => SettingsScreen(userInfo: widget.userInfo),
              ),
            );
          },
        ),
        GestureDetector(
          onTap: () => _navigateToProfile(),
          child: Container(
            margin: const EdgeInsets.only(right: 16),
            child: _buildProfileAvatar(),
          ),
        ),
      ],
    );
  }

  Widget _buildVerseOfTheDaySection() {
    return Container(
      margin: const EdgeInsets.all(16),
      child: StreamBuilder<DocumentSnapshot?>(
        stream: _verseService.getCurrentVerseOfTheDay(),
        builder: (context, snapshot) {
          if (snapshot.hasError) {
            return const SizedBox.shrink();
          }

          if (!snapshot.hasData ||
              snapshot.data == null ||
              !snapshot.data!.exists) {
            return const SizedBox.shrink();
          }

          final verseData = snapshot.data!.data() as Map<String, dynamic>;
          final verse = verseData['content'] ?? '';
          final reference = verseData['reference'] ?? '';
          final explanation = verseData['explanation'] ?? '';

          return Card(
            elevation: 4,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(16),
            ),
            child: Container(
              decoration: BoxDecoration(
                borderRadius: BorderRadius.circular(16),
                gradient: const LinearGradient(
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                  colors: [Color(0xFF1E3A8A), Color(0xFF3B82F6)],
                ),
              ),
              child: Padding(
                padding: const EdgeInsets.all(20),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Row(
                      children: [
                        const Icon(
                          Icons.book,
                          color: Colors.white,
                          size: 24,
                        ),
                        const SizedBox(width: 8),
                        const Text(
                          'Verse of the Day',
                          style: TextStyle(
                            color: Colors.white,
                            fontSize: 18,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 16),
                    Text(
                      verse,
                      style: const TextStyle(
                        color: Colors.white,
                        fontSize: 20,
                        fontWeight: FontWeight.w500,
                        fontStyle: FontStyle.italic,
                      ),
                    ),
                    const SizedBox(height: 8),
                    Text(
                      reference,
                      style: const TextStyle(
                        color: Colors.white70,
                        fontSize: 16,
                        fontWeight: FontWeight.w500,
                      ),
                    ),
                    if (explanation.isNotEmpty) ...[
                      const SizedBox(height: 12),
                      Text(
                        explanation,
                        style: const TextStyle(
                          color: Colors.white,
                          fontSize: 14,
                          height: 1.4,
                        ),
                      ),
                    ],
                    const SizedBox(height: 16),
                    Row(
                      children: [
                        IconButton(
                          onPressed: () {
                            // TODO: Share verse functionality
                          },
                          icon: const Icon(
                            Icons.share,
                            color: Colors.white,
                          ),
                        ),
                        IconButton(
                          onPressed: () {
                            // TODO: Like verse functionality
                          },
                          icon: const Icon(
                            Icons.favorite_border,
                            color: Colors.white,
                          ),
                        ),
                      ],
                    ),
                  ],
                ),
              ),
            ),
          );
        },
      ),
    );
  }

  Widget _buildStoriesSection() {
    return Container(
      height: 220, // Increased height to prevent overflow
      padding: const EdgeInsets.all(16),
      child: StreamBuilder<QuerySnapshot>(
        stream: _postService.getStories(),
        builder: (context, snapshot) {
          if (snapshot.hasError) {
            return const Center(child: Text('Error loading stories'));
          }

          if (!snapshot.hasData) {
            return const Center(child: CircularProgressIndicator());
          }

          final allStories = snapshot.data!.docs;

          // Filter stories to only show from followed users and current user
          return FutureBuilder<List<String>>(
            future: _getFollowingUserIds(),
            builder: (context, followingSnapshot) {
              if (!followingSnapshot.hasData) {
                return const Center(child: CircularProgressIndicator());
              }

              final followingUserIds = followingSnapshot.data!;
              // Include current user's own userId to show their own stories
              final currentUserId = _auth.currentUser?.uid;
              final allowedUserIds = [...followingUserIds];
              if (currentUserId != null &&
                  !allowedUserIds.contains(currentUserId)) {
                allowedUserIds.add(currentUserId);
              }

              final filteredStories = allStories.where((story) {
                final storyData = story.data() as Map<String, dynamic>;
                return allowedUserIds.contains(storyData['userId']);
              }).toList();

              // Group stories by user and get the latest story for each user
              final Map<String, List<QueryDocumentSnapshot>> storiesByUser = {};
              for (final story in filteredStories) {
                final storyData = story.data() as Map<String, dynamic>;
                final userId = storyData['userId'] as String;
                if (!storiesByUser.containsKey(userId)) {
                  storiesByUser[userId] = [];
                }
                storiesByUser[userId]!.add(story);
              }

              // Get the latest story for each user
              final List<Map<String, dynamic>> latestStories = [];
              for (final userStories in storiesByUser.values) {
                // Sort user's stories by timestamp (newest first)
                userStories.sort((a, b) {
                  final aData = a.data() as Map<String, dynamic>;
                  final bData = b.data() as Map<String, dynamic>;
                  final aTimestamp = aData['timestamp'] as Timestamp?;
                  final bTimestamp = bData['timestamp'] as Timestamp?;
                  if (aTimestamp == null || bTimestamp == null) return 0;
                  return bTimestamp.compareTo(aTimestamp);
                });

                final latestStory = userStories.first;
                final storyData = latestStory.data() as Map<String, dynamic>;
                latestStories.add({
                  ...storyData,
                  'storyCount': userStories.length,
                  'allStories': userStories,
                });
              }

              // Sort by timestamp descending to show newest first
              latestStories.sort((a, b) {
                final aTimestamp = a['timestamp'] as Timestamp?;
                final bTimestamp = b['timestamp'] as Timestamp?;
                if (aTimestamp == null || bTimestamp == null) return 0;
                return bTimestamp.compareTo(aTimestamp);
              });

              return ListView.builder(
                scrollDirection: Axis.horizontal,
                itemCount:
                    latestStories.length + 1, // +1 for "Add Status" button
                itemBuilder: (context, index) {
                  if (index == 0) {
                    return _buildAddStoryCard();
                  }

                  final storyData = latestStories[index - 1];

                  // Debug: Print story data to see what's available
                  print('Story data: $storyData');
                  print('Story imageUrl: ${storyData['imageUrl']}');
                  return _buildStoryCard(storyData);
                },
              );
            },
          );
        },
      ),
    );
  }

  Widget _buildAddStoryCard() {
    return Container(
      width: 120,
      margin: const EdgeInsets.only(right: 12),
      child: Card(
        elevation: 4,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(16),
        ),
        child: InkWell(
          onTap: () => _navigateToCreatePost(isStory: true),
          borderRadius: BorderRadius.circular(16),
          child: Container(
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(16),
              gradient: const LinearGradient(
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
                colors: [Color(0xFF1E3A8A), Color(0xFF3B82F6)],
              ),
            ),
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                const CircleAvatar(
                  backgroundColor: Colors.white,
                  radius: 25,
                  child: Icon(
                    Icons.add,
                    color: Color(0xFF1E3A8A),
                    size: 30,
                  ),
                ),
                const SizedBox(height: 8),
                const Text(
                  'Add Status',
                  style: TextStyle(
                    color: Colors.white,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildStoryCard(Map<String, dynamic> storyData) {
    return Container(
      width: 120,
      margin: const EdgeInsets.only(right: 12),
      child: Card(
        elevation: 4,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(16),
        ),
        child: InkWell(
          onTap: () async {
            // Get user data for the story author
            final userData =
                await _userService.getUserById(storyData['userId']);
            final authorName = userData?['name'] ?? 'User';

            Navigator.of(context).push(
              MaterialPageRoute(
                builder: (context) => StoryViewerScreen(
                  imageUrl: storyData['imageUrl'],
                  authorName: authorName,
                  timestamp: storyData['timestamp'] as Timestamp?,
                ),
              ),
            );
          },
          borderRadius: BorderRadius.circular(16),
          child: Container(
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(16),
              border: Border.all(
                color: Colors.blue, // Blue border to indicate new status
                width: 3,
              ),
              image: storyData['imageUrl'] != null &&
                      storyData['imageUrl']!.isNotEmpty &&
                      !storyData['imageUrl']!.contains('placeholder')
                  ? DecorationImage(
                      image: NetworkImage(storyData['imageUrl']!),
                      fit: BoxFit.cover,
                      onError: (exception, stackTrace) {
                        print('Error loading story image: $exception');
                      },
                    )
                  : null,
            ),
            child: Container(
              decoration: BoxDecoration(
                borderRadius: BorderRadius.circular(16),
                gradient: LinearGradient(
                  begin: Alignment.topCenter,
                  end: Alignment.bottomCenter,
                  colors: [
                    Colors.transparent,
                    Colors.black.withOpacity(0.7),
                  ],
                ),
              ),
              child: Padding(
                padding: const EdgeInsets.all(12),
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.end,
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    FutureBuilder<Map<String, dynamic>?>(
                      future: _userService.getUserById(storyData['userId']),
                      builder: (context, userSnapshot) {
                        if (userSnapshot.hasData && userSnapshot.data != null) {
                          final userData = userSnapshot.data!;
                          final userName = userData['name'] ?? 'User';
                          final profileUrl = userData['profilePictureUrl'];

                          return Row(
                            children: [
                              CircleAvatar(
                                radius: 12,
                                backgroundColor: Colors.white,
                                backgroundImage: profileUrl != null &&
                                        profileUrl.isNotEmpty &&
                                        !profileUrl.contains('placeholder')
                                    ? NetworkImage(profileUrl)
                                    : null,
                                child: profileUrl == null ||
                                        profileUrl.isEmpty ||
                                        profileUrl.contains('placeholder')
                                    ? Text(
                                        _getAvatarLetterFromName(userName),
                                        style: const TextStyle(
                                          fontWeight: FontWeight.bold,
                                          color: Colors.blue,
                                          fontSize: 10,
                                        ),
                                      )
                                    : null,
                                onBackgroundImageError: profileUrl != null &&
                                        profileUrl.isNotEmpty &&
                                        !profileUrl.contains('placeholder')
                                    ? (exception, stackTrace) {
                                        print(
                                            'Error loading profile picture in story: $exception');
                                      }
                                    : null,
                              ),
                              const SizedBox(width: 6),
                              Expanded(
                                child: Text(
                                  userName,
                                  style: const TextStyle(
                                    color: Colors.white,
                                    fontWeight: FontWeight.bold,
                                    fontSize: 12,
                                  ),
                                  maxLines: 1,
                                  overflow: TextOverflow.ellipsis,
                                ),
                              ),
                            ],
                          );
                        }
                        return const Text(
                          'User',
                          style: TextStyle(
                            color: Colors.white,
                            fontWeight: FontWeight.bold,
                            fontSize: 12,
                          ),
                        );
                      },
                    ),
                  ],
                ),
              ),
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildCreatePostSection() {
    return Container(
      margin: const EdgeInsets.all(16),
      child: Card(
        elevation: 2,
        child: Padding(
          padding: const EdgeInsets.all(16),
          child: Row(
            children: [
              Stack(
                children: [
                  CircleAvatar(
                    backgroundColor: Colors.grey[300],
                    backgroundImage: widget.userInfo['profilePictureUrl'] !=
                                null &&
                            widget.userInfo['profilePictureUrl']!.isNotEmpty &&
                            !widget.userInfo['profilePictureUrl']!
                                .contains('placeholder')
                        ? NetworkImage(widget.userInfo['profilePictureUrl']!)
                        : null,
                    child: widget.userInfo['profilePictureUrl'] == null ||
        }

        final posts = snapshot.data!.docs;

        // Filter out status posts (stories)
        final filteredPosts = posts.where((post) {
          final postData = post.data() as Map<String, dynamic>;
          return !(postData['isStory'] ?? false);
        }).toList();

        // Add hardcoded sample posts promoting Christianity for warm welcome
        final samplePosts = [
          _FakeQueryDocumentSnapshot('sample1', {
            'userId': 'sample_user_1',
            'content':
                'Welcome to our beautiful church community! May this place be a beacon of hope and faith for all who enter.',
            'imageUrl':
                'https://images.unsplash.com/photo-1438232992991-995b7058bbb3?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80',
            'timestamp': Timestamp.now(),
            'likes': 42,
            'comments': 12,
            'shares': 5,
          }),
          _FakeQueryDocumentSnapshot('sample2', {
            'userId': 'sample_user_2',
            'content':
                '"For I know the plans I have for you," declares the LORD, "plans to prosper you and not to harm you, plans to give you hope and a future." - Jeremiah 29:11\n\nLet this verse remind us that God has a perfect plan for each of us.',
            'timestamp': Timestamp.now(),
            'likes': 67,
            'comments': 8,
            'shares': 15,
          }),
          _FakeQueryDocumentSnapshot('sample3', {
            'userId': 'sample_user_3',
            'content':
                'üôè Heavenly Father, we thank you for this day and for the blessings you have given us. Guide us in your ways and help us to love one another as you have loved us. Strengthen our faith and fill our hearts with your peace. In Jesus\' name, Amen.',
            'timestamp': Timestamp.now(),
            'likes': 89,
            'comments': 23,
            'shares': 7,
          }),
          _FakeQueryDocumentSnapshot('sample4', {
            'userId': 'sample_user_4',
            'content':
                'A beautiful reminder of God\'s love and the power of community in Christ.',
            'videoUrl':
                'https://flutter.github.io/assets-for-api-docs/assets/videos/bee.mp4',
            'timestamp': Timestamp.now(),
            'likes': 34,
            'comments': 6,
            'shares': 3,
          }),
          _FakeQueryDocumentSnapshot('sample5', {
            'userId': 'sample_user_5',
            'content':
                'Join us in prayer for our community and the world. Let us be instruments of God\'s peace and love.',
            'imageUrl':
                'https://images.unsplash.com/photo-1507692049790-de58290a4354?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80',
            'timestamp': Timestamp.now(),
            'likes': 56,
            'comments': 18,
            'shares': 9,
          }),
          _FakeQueryDocumentSnapshot('sample6', {
            'userId': 'sample_user_6',
            'content':
                '"Trust in the LORD with all your heart and lean not on your own understanding; in all your ways submit to him, and he will make your paths straight." - Proverbs 3:5-6\n\nA powerful reminder to trust in God\'s wisdom above our own.',
            'imageUrl':
                'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80',
            'timestamp': Timestamp.now(),
            'likes': 78,
            'comments': 14,
            'shares': 22,
          }),
          _FakeQueryDocumentSnapshot('sample7', {
            'userId': 'sample_user_7',
            'content':
                'Experience the joy of worship through this beautiful church service video. Let the music and message uplift your spirit today!',
            'videoUrl':
                'https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_1mb.mp4',
            'timestamp': Timestamp.now(),
            'likes': 91,
            'comments': 27,
            'shares': 18,
          }),
          _FakeQueryDocumentSnapshot('sample8', {
            'userId': 'sample_user_8',
            'content':
                '"Be strong and courageous. Do not be afraid; do not be discouraged, for the LORD your God will be with you wherever you go." - Joshua 1:9\n\nGod\'s promise of strength and presence in our lives.',
            'timestamp': Timestamp.now(),
            'likes': 103,
            'comments': 19,
            'shares': 31,
          }),
          _FakeQueryDocumentSnapshot('sample9', {
            'userId': 'sample_user_9',
            'content':
                'Our church family gathered for a special community outreach event. What a blessing to serve together and spread God\'s love!',
            'imageUrl':
                'https://images.unsplash.com/photo-1511632765486-a01980e01a18?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80',
            'timestamp': Timestamp.now(),
            'likes': 65,
            'comments': 11,
            'shares': 8,
          }),
          _FakeQueryDocumentSnapshot('sample10', {
            'userId': 'sample_user_10',
            'content':
                'üôè Lord, we pray for healing in our communities, strength for those in need, and wisdom for our leaders. May your peace reign in every heart. Amen.',
            'imageUrl':
                'https://images.unsplash.com/photo-1544197150-b99a580bb7a8?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80',
            'timestamp': Timestamp.now(),
            'likes': 84,
            'comments': 16,
            'shares': 12,
          }),
          _FakeQueryDocumentSnapshot('sample11', {
            'userId': 'sample_user_11',
            'content':
                'Watch this inspiring testimony of faith and transformation. God\'s grace is truly amazing!',
            'videoUrl':
                'https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_2mb.mp4',
            'timestamp': Timestamp.now(),
            'likes': 72,
            'comments': 9,
            'shares': 14,
          }),
          _FakeQueryDocumentSnapshot('sample12', {
            'userId': 'sample_user_12',
            'content':
                '"And we know that in all things God works for the good of those who love him, who have been called according to his purpose." - Romans 8:28\n\nEven in difficult times, God is working for our good.',
            'imageUrl':
                'https://images.unsplash.com/photo-1544197150-b99a580bb7a8?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80',
            'timestamp': Timestamp.now(),
            'likes': 96,
            'comments': 21,
            'shares': 25,
          }),
          _FakeQueryDocumentSnapshot('sample13', {
            'userId': 'sample_user_13',
            'content':
                'Beautiful stained glass windows in our sanctuary, reminding us of God\'s colorful promises and eternal light.',
            'imageUrl':
                'https://images.unsplash.com/photo-1544378730-6f3c834d9b2d?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80',
            'timestamp': Timestamp.now(),
            'likes': 58,
            'comments': 7,
            'shares': 6,
          }),
          _FakeQueryDocumentSnapshot('sample14', {
            'userId': 'sample_user_14',
            'content':
                'Join us for our weekly Bible study! This week we\'re exploring the book of Psalms and discovering God\'s heart through worship and praise.',
            'imageUrl':
                'https://images.unsplash.com/photo-1481627834876-b7833e8f5570?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80',
            'timestamp': Timestamp.now(),
            'likes': 47,
            'comments': 13,
            'shares': 9,
          }),
          _FakeQueryDocumentSnapshot('sample15', {
            'userId': 'sample_user_15',
            'content':
                '"For God so loved the world that he gave his one and only Son, that whoever believes in him shall not perish but have eternal life." - John 3:16\n\nThe greatest love story ever told.',
            'videoUrl':
                'https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_5mb.mp4',
            'timestamp': Timestamp.now(),
            'likes': 112,
            'comments': 33,
            'shares': 41,
          }),
        ];

        filteredPosts.insertAll(0, samplePosts);

        if (filteredPosts.isEmpty) {
          return const Center(
            child: Padding(
              padding: EdgeInsets.all(32),
              child: Text(
                'No posts available yet. Be the first to share something!',
                style: TextStyle(
                  fontSize: 18,
                  color: Colors.grey,
                ),
                textAlign: TextAlign.center,
              ),
            ),
          );
        }

        return ListView.builder(
          shrinkWrap: true,
          physics: const NeverScrollableScrollPhysics(),
          itemCount: filteredPosts.length,
          itemBuilder: (context, index) {
            final post = filteredPosts[index];
            final postData = post.data() as Map<String, dynamic>;

            return _buildPostCard(post.id, postData);
          },
        );
      },
    );
  }

  Widget _buildPostCard(String postId, Map<String, dynamic> postData) {
    return Container(
      margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
      child: Card(
        elevation: 2,
        child: Padding(
          padding: const EdgeInsets.all(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // Post header
              Row(
                children: [
                  FutureBuilder<Map<String, dynamic>?>(
                    future: _userService.getUserById(postData['userId']),
                    builder: (context, userSnapshot) {
                      if (userSnapshot.hasData && userSnapshot.data != null) {
                        final userData = userSnapshot.data!;
                        return Row(
                          children: [
                            Stack(
                              children: [
                                CircleAvatar(
                                  backgroundColor: Colors.grey[300],
                                  backgroundImage:
                                      userData['profilePictureUrl'] != null &&
                                              userData['profilePictureUrl']!
                                                  .isNotEmpty &&
                                              !userData['profilePictureUrl']!
                                                  .contains('placeholder')
                                          ? NetworkImage(
                                              userData['profilePictureUrl']!)
                                          : null,
                                  child:
                                      userData['profilePictureUrl'] == null ||
                                              userData['profilePictureUrl']!
                                                  .isEmpty ||
                                              userData['profilePictureUrl']!
                                                  .contains('placeholder')
                                          ? Text(
                                              _getAvatarLetter(),
                                              style: const TextStyle(
                                                fontWeight: FontWeight.bold,
                                                color: Colors.grey,
                                              ),
                                            )
                                          : null,
                                ),
                                Positioned(
                                  bottom: 0,
                                  right: 0,
                                  child: OnlineStatusIndicator(
                                    userId: postData['userId'],
                                    size: 12,
                                  ),
                                ),
                              ],
                            ),
                            const SizedBox(width: 12),
                            Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  userData['name'] ?? 'User',
                                  style: const TextStyle(
                                    fontWeight: FontWeight.bold,
                                    fontSize: 16,
                                  ),
                                ),
                                Text(
                                  _formatTimestamp(postData['timestamp']),
                                  style: TextStyle(
                                    color: Colors.grey[600],
                                    fontSize: 12,
                                  ),
                                ),
                              ],
                            ),
                          ],
                        );
                      }
                      return const CircularProgressIndicator();
                    },
                  ),
                  const Spacer(),
                  if (postData['userId'] == _auth.currentUser?.uid)
                    PopupMenuButton(
                      itemBuilder: (context) => [
                        const PopupMenuItem(
                          value: 'delete',
                          child: Text('Delete'),
                        ),
                      ],
                      onSelected: (value) {
                        if (value == 'delete') {
                          _deletePost(postId);
                        }
                      },
                    ),
                ],
              ),
              const SizedBox(height: 12),

              // Post content
              if (postData['content']?.isNotEmpty == true)
                Text(
                  postData['content'],
                  style: const TextStyle(fontSize: 16),
                ),

              // Post media
              if (postData['imageUrl'] != null &&
                  postData['imageUrl']!.isNotEmpty)
                Container(
                  margin: const EdgeInsets.only(top: 12),
                  constraints: BoxConstraints(
                    maxHeight: MediaQuery.of(context).size.height *
                        0.5, // Max 50% of screen height
                  ),
                  child: ClipRRect(
                    borderRadius: BorderRadius.circular(8),
                    child: Image.network(
                      postData['imageUrl']!,
                      width: double.infinity,
                      fit: BoxFit.cover,
                      loadingBuilder: (context, child, loadingProgress) {
                        if (loadingProgress == null) return child;
                        return Container(
                          height: 200,
                          color: Colors.grey[200],
                          child: const Center(
                            child: CircularProgressIndicator(),
                          ),
                        );
                      },
                      errorBuilder: (context, error, stackTrace) {
                        print('Error loading post image: $error');
                        print('Image URL: ${postData['imageUrl']}');
                        return Container(
                          height: 200,
                          color: Colors.grey[200],
                          child: Column(
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              const Icon(
                                Icons.broken_image,
                                size: 48,
                                color: Colors.grey,
                              ),
                              const SizedBox(height: 8),
                              Text(
                                'Failed to load image',
                                style: TextStyle(color: Colors.grey[600]),
                              ),
                              const SizedBox(height: 4),
                              Text(
                                'URL: ${postData['imageUrl']}',
                                style: TextStyle(
                                  color: Colors.grey[400],
                                  fontSize: 10,
                                ),
                                textAlign: TextAlign.center,
                              ),
                            ],
                          ),
                        );
                      },
                    ),
                  ),
                ),

              if (postData['videoUrl'] != null)
                Container(
                  margin: const EdgeInsets.only(top: 12),
                  child: ClipRRect(
                    borderRadius: BorderRadius.circular(8),
                    child: AspectRatio(
                      aspectRatio: 16 / 9,
                      child: InkWell(
                        onTap: () {
                          // Navigate to ContentScreen with Videos tab selected
                          setState(() {
                            _contentInitialTab = 0; // Videos tab
                            _selectedIndex = 1; // Content tab
                          });
                        },
                        child: FeedVideoPlayer(
                          videoUrl: postData['videoUrl'],
                        ),
                      ),
                    ),
                  ),
                ),

              const SizedBox(height: 16),

              // Post actions
              Row(
                children: [
                  FutureBuilder<bool>(
                    future: _postService.isPostLiked(postId),
                    builder: (context, likeSnapshot) {
                      final isLiked = likeSnapshot.data ?? false;
                      return Row(
                        children: [
                          IconButton(
                            onPressed: () => _postService.likePost(postId),
                            icon: Icon(
                              isLiked ? Icons.favorite : Icons.favorite_border,
                              color: isLiked ? Colors.red : Colors.grey,
                            ),
                          ),
                          Text('${postData['likes'] ?? 0}'),
                        ],
                      );
                    },
                  ),
                  const SizedBox(width: 16),
                  Row(
                    children: [
                      IconButton(
                        onPressed: () => _showCommentsDialog(postId, postData),
                        icon: const Icon(Icons.comment_outlined),
                      ),
                      Text('${postData['comments'] ?? 0}'),
                    ],
                  ),
                  const SizedBox(width: 16),
                  Row(
                    children: [
                      IconButton(
                        onPressed: () => _postService.sharePost(postId),
                        icon: const Icon(Icons.share_outlined),
                      ),
                      Text('${postData['shares'] ?? 0}'),
                    ],
                  ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }

  String _formatTimestamp(Timestamp? timestamp) {
    if (timestamp == null) return '';

    final now = DateTime.now();
    final postTime = timestamp.toDate();
    final difference = now.difference(postTime);

    if (difference.inDays > 0) {
      return DateFormat('MMM d').format(postTime);
    } else if (difference.inHours > 0) {
      return '${difference.inHours}h ago';
    } else if (difference.inMinutes > 0) {
      return '${difference.inMinutes}m ago';
    } else {
      return 'Just now';
    }
  }

  void _navigateToCreatePost({bool isStory = false}) {
    Navigator.of(context).push(
      MaterialPageRoute(
        builder: (context) => CreatePostScreen(
          userInfo: widget.userInfo,
          isStory: isStory,
        ),
      ),
    );
  }

  void _navigateToProfile() async {
    final userService = UserService();
    final completeUserInfo = await userService.getUserInfo();

    if (completeUserInfo != null) {
      // Convert the complete user info to a Map<String, String>
      final userInfoMap = completeUserInfo.map((key, value) {
        if (value is Timestamp) {
          // Convert Timestamp to ISO string
          return MapEntry(key, value.toDate().toIso8601String());
        } else if (value is int || value is double) {
          // Convert numbers to string
          return MapEntry(key, value.toString());
        } else if (value is bool) {
          // Convert boolean to string
          return MapEntry(key, value.toString());
        } else {
          // Handle null and other types
          return MapEntry(key, value?.toString() ?? '');
        }
      });

      Navigator.of(context).push(
        MaterialPageRoute(
          builder: (context) => FacebookProfileScreen(userInfo: userInfoMap),
        ),
      );
    } else {
      // Fallback to the original userInfo if complete data is not available
      Navigator.of(context).push(
        MaterialPageRoute(
          builder: (context) =>
              FacebookProfileScreen(userInfo: widget.userInfo),
        ),
      );
    }
  }

  void _deletePost(String postId) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Delete Post'),
        content: const Text('Are you sure you want to delete this post?'),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(),
            child: const Text('Cancel'),
          ),
          TextButton(
            onPressed: () {
              _postService.deletePost(postId);
              Navigator.of(context).pop();
            },
            child: const Text(
              'Delete',
              style: TextStyle(color: Colors.red),
            ),
          ),
        ],
      ),
    );
  }

  void _showCommentsDialog(String postId, Map<String, dynamic> postData) {
    final TextEditingController commentController = TextEditingController();

    showDialog(
      context: context,
      builder: (BuildContext context) {
        return Dialog(
          shape:
              RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
          child: Container(
            width: double.maxFinite,
            height: MediaQuery.of(context).size.height * 0.7,
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(16),
              color: Colors.white,
            ),
            child: Column(
              children: [
                // Header
                Container(
                  padding: const EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    color: const Color(0xFF1E3A8A),
                    borderRadius: const BorderRadius.only(
                      topLeft: Radius.circular(16),
                      topRight: Radius.circular(16),
                    ),
                  ),
                  child: Row(
                    children: [
                      const Icon(Icons.comment, color: Colors.white, size: 24),
                      const SizedBox(width: 12),
                      const Text(
                        'Comments',
                        style: TextStyle(
                          color: Colors.white,
                          fontSize: 18,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                      const Spacer(),
                      IconButton(
                        icon: const Icon(Icons.close, color: Colors.white),
                        onPressed: () => Navigator.of(context).pop(),
                      ),
                    ],
                  ),
                ),

                // Comments list
                Expanded(
                  child: StreamBuilder<QuerySnapshot>(
                    stream: _postService.getPostComments(postId),
                    builder: (context, snapshot) {
                      if (snapshot.hasError) {
                        return const Center(
                            child: Text('Error loading comments'));
                      }

                      if (!snapshot.hasData) {
                        return const Center(child: CircularProgressIndicator());
                      }

                      final comments = snapshot.data!.docs;

                      if (comments.isEmpty) {
                        return Center(
                          child: Column(
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              Icon(
                                Icons.comment_outlined,
                                size: 64,
                                color: Colors.grey.shade400,
                              ),
                              const SizedBox(height: 16),
                              Text(
                                'No comments yet',
                                style: TextStyle(
                                  fontSize: 18,
                                  fontWeight: FontWeight.bold,
                                  color: Colors.grey[600],
                                ),
                              ),
                              const SizedBox(height: 8),
                              Text(
                                'Be the first to share your thoughts!',
                                style: TextStyle(
                                  color: Colors.grey[500],
                                ),
                              ),
                            ],
                          ),
                        );
                      }

                      return ListView.builder(
                        padding: const EdgeInsets.all(16),
                        itemCount: comments.length,
                        itemBuilder: (context, index) {
                          final comment = comments[index];
                          final commentData =
                              comment.data() as Map<String, dynamic>;
                          return _buildCommentItem(commentData);
                        },
                      );
                    },
                  ),
                ),

                // Comment input
                Container(
                  padding: const EdgeInsets.all(16),
                  decoration: BoxDecoration(
                    border: Border(
                      top: BorderSide(color: Colors.grey.withOpacity(0.2)),
                    ),
                  ),
                  child: Row(
                    children: [
                      Expanded(
                        child: Container(
                          decoration: BoxDecoration(
                            color: Colors.grey[100],
                            borderRadius: BorderRadius.circular(25),
                          ),
                          child: TextField(
                            controller: commentController,
                            decoration: const InputDecoration(
                              hintText: 'Write a comment...',
                              border: InputBorder.none,
                              contentPadding: EdgeInsets.symmetric(
                                horizontal: 16,
                                vertical: 12,
                              ),
                            ),
                            maxLines: null,
                            textInputAction: TextInputAction.send,
                            onSubmitted: (value) async {
                              if (value.trim().isNotEmpty) {
                                await _postService.addComment(
                                    postId, value.trim());
                                commentController.clear();
                              }
                            },
                          ),
                        ),
                      ),
                      const SizedBox(width: 8),
                      Container(
                        decoration: BoxDecoration(
                          color: const Color(0xFF1E3A8A),
                          borderRadius: BorderRadius.circular(25),
                        ),
                        child: IconButton(
                          icon: const Icon(Icons.send, color: Colors.white),
                          onPressed: () async {
                            if (commentController.text.trim().isNotEmpty) {
                              await _postService.addComment(
                                  postId, commentController.text.trim());
                              commentController.clear();
                            }
                          },
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
        );
      },
    ).whenComplete(() {
      commentController.dispose();
    });
  }

  Widget _buildCommentItem(Map<String, dynamic> commentData) {
    return Container(
      margin: const EdgeInsets.symmetric(vertical: 8),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // User avatar
          FutureBuilder<Map<String, dynamic>?>(
            future: _userService.getUserById(commentData['userId']),
            builder: (context, userSnapshot) {
              if (userSnapshot.hasData && userSnapshot.data != null) {
                final userData = userSnapshot.data!;
                return Stack(
                  children: [
                    CircleAvatar(
                      radius: 16,
                      backgroundColor: Colors.grey[300],
                      backgroundImage: userData['profilePictureUrl'] != null &&
                              userData['profilePictureUrl']!.isNotEmpty &&
                              !userData['profilePictureUrl']!
                                  .contains('placeholder')
                          ? NetworkImage(userData['profilePictureUrl']!)
                          : null,
                      child: userData['profilePictureUrl'] == null ||
                              userData['profilePictureUrl']!.isEmpty ||
                              userData['profilePictureUrl']!
                                  .contains('placeholder')
                          ? Text(
                              _getAvatarLetterFromName(
                                  userData['name'] ?? 'User'),
                              style: const TextStyle(
                                fontWeight: FontWeight.bold,
                                color: Colors.grey,
                                fontSize: 12,
                              ),
                            )
                          : null,
                    ),
                    Positioned(
                      bottom: 0,
                      right: 0,
                      child: OnlineStatusIndicator(
                        userId: commentData['userId'],
                        size: 8,
                      ),
                    ),
                  ],
                );
              }
              return CircleAvatar(
                radius: 16,
                backgroundColor: Colors.grey[300],
                child: const Icon(Icons.person, size: 16, color: Colors.grey),
              );
            },
          ),
          const SizedBox(width: 12),
          // Comment content
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                // User name and timestamp
                FutureBuilder<Map<String, dynamic>?>(
                  future: _userService.getUserById(commentData['userId']),
                  builder: (context, userSnapshot) {
                    final userName = userSnapshot.data?['name'] ?? 'User';
                    final timestamp = commentData['timestamp'] as Timestamp?;
                    final timeAgo =
                        timestamp != null ? _formatTimestamp(timestamp) : '';

                    return Row(
                      children: [
                        Text(
                          userName,
                          style: const TextStyle(
                            fontWeight: FontWeight.bold,
                            fontSize: 14,
                          ),
                        ),
                        const SizedBox(width: 8),
                        Text(
                          timeAgo,
                          style: TextStyle(
                            color: Colors.grey[600],
                            fontSize: 12,
                          ),
                        ),
                      ],
                    );
                  },
                ),
                const SizedBox(height: 4),
                // Comment text
                Text(
                  commentData['comment'] ?? '',
                  style: const TextStyle(fontSize: 14),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Future<List<String>> _getFollowingUserIds() async {
    final user = _auth.currentUser;
    if (user == null) return [];

    try {
      final userDoc = await FirebaseFirestore.instance
          .collection('users')
          .doc(user.uid)
          .get();

      final following = List<String>.from(userDoc.data()?['following'] ?? []);
      return following;
    } catch (e) {
      print('Error getting following users: $e');
      return [];
    }
  }

  String _getAvatarLetter() {
    final name = widget.userInfo['name'];
    if (name != null && name.isNotEmpty && name.trim().isNotEmpty) {
      final firstChar = name.trim()[0].toUpperCase();
      // Avoid showing 'U' if the first letter happens to be 'U'
      return firstChar != 'U'
          ? firstChar
          : (name.length > 1 ? name[1].toUpperCase() : 'A');
    }
    return 'A'; // Default fallback
  }

  String _getAvatarLetterFromName(String name) {
    if (name.isNotEmpty && name.trim().isNotEmpty) {
      final firstChar = name.trim()[0].toUpperCase();
      // Avoid showing 'U' if the first letter happens to be 'U'
      return firstChar != 'U'
          ? firstChar
          : (name.length > 1 ? name[1].toUpperCase() : 'A');
    }
    return 'A'; // Default fallback
  }

  ImageProvider? _getProfileImage() {
    final profileUrl = widget.userInfo['profilePictureUrl'];
    if (profileUrl != null &&
        profileUrl.isNotEmpty &&
        !profileUrl.contains('placeholder')) {
      return NetworkImage(profileUrl);
    }
    return null;
  }

  Widget? _getProfileChild() {
    final profileUrl = widget.userInfo['profilePictureUrl'];
    if (profileUrl == null ||
        profileUrl.isEmpty ||
        profileUrl.contains('placeholder')) {
      return Text(
        _getAvatarLetter(),
        style: const TextStyle(
          fontWeight: FontWeight.bold,
          fontSize: 18,
        ),
      );
    }
    return null;
  }

  Widget _buildProfileAvatar() {
    final profileImage = _getProfileImage();
    final profileChild = _getProfileChild();

    return Stack(
      children: [
        CircleAvatar(
          backgroundColor: Colors.white,
          foregroundColor: const Color(0xFF1E3A8A),
          backgroundImage: profileImage,
          child: profileChild,
          onBackgroundImageError: profileImage != null
              ? (exception, stackTrace) {
                  print('Error loading profile picture in app bar: $exception');
                }
              : null,
        ),
        Positioned(
          bottom: 0,
          right: 0,
          child: OnlineStatusIndicator(
            userId: _auth.currentUser?.uid ?? '',
            size: 8,
          ),
        ),
      ],
    );
  }
}

class _FakeQueryDocumentSnapshot extends QueryDocumentSnapshot {
  final String _id;
  final Map<String, dynamic> _data;

  _FakeQueryDocumentSnapshot(this._id, this._data);

  @override
  Map<String, dynamic> data() => _data;

  @override
  String get id => _id;

  @override
  dynamic noSuchMethod(Invocation invocation) => super.noSuchMethod(invocation);
}

class _ChurchSearchDelegate extends SearchDelegate<String> {
  final Map<String, String> userInfo;
  final ChurchService _churchService = ChurchService();

  _ChurchSearchDelegate({required this.userInfo});

  @override
  List<Widget> buildActions(BuildContext context) {
    return [
      IconButton(
        icon: const Icon(Icons.clear),
        onPressed: () {
          query = '';
        },
      ),
    ];
  }

  @override
  Widget buildLeading(BuildContext context) {
    return IconButton(
      icon: const Icon(Icons.arrow_back),
      onPressed: () {
        close(context, '');
      },
    );
  }

  @override
  Widget buildResults(BuildContext context) {
    return _buildChurchSearchResults(context);
  }

  @override
  Widget buildSuggestions(BuildContext context) {
    return _buildChurchSearchResults(context);
  }

  Widget _buildChurchSearchResults(BuildContext context) {
    if (query.isEmpty) {
      return Container(
        padding: const EdgeInsets.all(24),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const Icon(
              Icons.church,
              size: 80,
              color: Color(0xFF1E3A8A),
            ),
            const SizedBox(height: 16),
            const Text(
              'Find Your Church',
              style: TextStyle(
                fontSize: 24,
                fontWeight: FontWeight.bold,
                color: Color(0xFF1E3A8A),
              ),
            ),
            const SizedBox(height: 8),
            const Text(
              'Search for churches by name, denomination, or location',
              textAlign: TextAlign.center,
              style: TextStyle(
                fontSize: 16,
                color: Colors.grey,
              ),
            ),
            const SizedBox(height: 24),
            ElevatedButton.icon(
              onPressed: () {
                // Show all churches
                query = '';
                showResults(context);
              },
              icon: const Icon(Icons.explore),
              label: const Text('Browse All Churches'),
              style: ElevatedButton.styleFrom(
                backgroundColor: const Color(0xFF1E3A8A),
                foregroundColor: Colors.white,
                padding:
                    const EdgeInsets.symmetric(horizontal: 24, vertical: 12),
              ),
            ),
          ],
        ),
      );
    }

    return StreamBuilder<QuerySnapshot>(
      stream: _performChurchSearch(query),
      builder: (context, snapshot) {
        if (snapshot.connectionState == ConnectionState.waiting) {
          return const Center(child: CircularProgressIndicator());
        }

        if (snapshot.hasError) {
          return Center(child: Text('Error: ${snapshot.error}'));
        }

        final churches = snapshot.data?.docs ?? [];

        if (churches.isEmpty) {
          return Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                const Icon(
                  Icons.church_outlined,
                  size: 64,
                  color: Colors.grey,
                ),
                const SizedBox(height: 16),
                const Text(
                  'No churches found',
                  style: TextStyle(
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                const SizedBox(height: 8),
                Text(
                  'Try searching with different keywords',
                  style: TextStyle(color: Colors.grey[600]),
                ),
              ],
            ),
          );
        }

        return ListView.builder(
          itemCount: churches.length,
          itemBuilder: (context, index) {
            final church = churches[index];
            final churchData = church.data() as Map<String, dynamic>;
            return _buildChurchCard(context, church.id, churchData);
          },
        );
      },
    );
  }

  Widget _buildChurchCard(
      BuildContext context, String churchId, Map<String, dynamic> churchData) {
    final isUserMember = userInfo['churchId'] == churchId;

    return Card(
      margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
      elevation: 2,
      child: InkWell(
        onTap: () => _showChurchDetails(context, churchId, churchData),
        child: Padding(
          padding: const EdgeInsets.all(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(
                children: [
                  CircleAvatar(
                    radius: 30,
                    backgroundColor: const Color(0xFF1E3A8A),
                    child: const Icon(
                      Icons.church,
                      color: Colors.white,
                      size: 30,
                    ),
                  ),
                  const SizedBox(width: 16),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          churchData['churchName'] ?? 'Church',
                          style: const TextStyle(
                            fontSize: 18,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                        Text(
                          churchData['denomination'] ?? 'Christian Church',
                          style: TextStyle(
                            color: Colors.grey[600],
                            fontSize: 14,
                          ),
                        ),
                        Text(
                          '${churchData['memberCount'] ?? 0} members',
                          style: TextStyle(
                            color: Colors.grey[600],
                            fontSize: 12,
                          ),
                        ),
                      ],
                    ),
                  ),
                  if (isUserMember)
                    Container(
                      padding: const EdgeInsets.symmetric(
                          horizontal: 8, vertical: 4),
                      decoration: BoxDecoration(
                        color: Colors.green[100],
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: const Text(
                        'Member',
                        style: TextStyle(
                          color: Colors.green,
                          fontSize: 12,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ),
                ],
              ),
              if (churchData['description']?.isNotEmpty == true) ...[
                const SizedBox(height: 12),
                Text(
                  churchData['description'],
                  style: TextStyle(
                    color: Colors.grey[700],
                    fontSize: 14,
                  ),
                  maxLines: 2,
                  overflow: TextOverflow.ellipsis,
                ),
              ],
              if (churchData['address']?.isNotEmpty == true) ...[
                const SizedBox(height: 8),
                Row(
                  children: [
                    const Icon(
                      Icons.location_on,
                      size: 16,
                      color: Colors.grey,
                    ),
                    const SizedBox(width: 4),
                    Expanded(
                      child: Text(
                        churchData['address'],
                        style: TextStyle(
                          color: Colors.grey[600],
                          fontSize: 12,
                        ),
                        maxLines: 1,
                        overflow: TextOverflow.ellipsis,
                      ),
                    ),
                  ],
                ),
              ],
              const SizedBox(height: 12),
              Row(
                children: [
                  Expanded(
                    child: ElevatedButton(
                      onPressed: isUserMember
                          ? () => _navigateToChurchChat(
                              context, churchId, churchData)
                          : () => _joinChurch(context, churchId, churchData),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: isUserMember
                            ? const Color(0xFF1E3A8A)
                            : Colors.green,
                        foregroundColor: Colors.white,
                      ),
                      child: Text(
                          isUserMember ? 'Open Church Chat' : 'Join Church'),
                    ),
                  ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }

  Stream<QuerySnapshot> _performChurchSearch(String searchQuery) {
    final churchService = ChurchService();

    if (searchQuery.isEmpty) {
      return churchService.getAllChurches();
    } else {
      return churchService.searchChurches(searchQuery);
    }
  }

  void _showChurchDetails(
      BuildContext context, String churchId, Map<String, dynamic> churchData) {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
      ),
      builder: (context) => DraggableScrollableSheet(
        expand: false,
        initialChildSize: 0.7,
        maxChildSize: 0.9,
        builder: (context, scrollController) => Container(
          padding: const EdgeInsets.all(24),
          child: ListView(
            controller: scrollController,
            children: [
              Row(
                children: [
                  CircleAvatar(
                    radius: 40,
                    backgroundColor: const Color(0xFF1E3A8A),
                    child: const Icon(
                      Icons.church,
                      color: Colors.white,
                      size: 40,
                    ),
                  ),
                  const SizedBox(width: 16),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          churchData['churchName'] ?? 'Church',
                          style: const TextStyle(
                            fontSize: 24,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                        Text(
                          churchData['denomination'] ?? 'Christian Church',
                          style: TextStyle(
                            color: Colors.grey[600],
                            fontSize: 16,
                          ),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
              const SizedBox(height: 24),
              if (churchData['description']?.isNotEmpty == true) ...[
                const Text(
                  'About',
                  style: TextStyle(
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                const SizedBox(height: 8),
                Text(
                  churchData['description'],
                  style: const TextStyle(fontSize: 16),
                ),
                const SizedBox(height: 16),
              ],
              if (churchData['address']?.isNotEmpty == true) ...[
                const Text(
                  'Location',
                  style: TextStyle(
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                const SizedBox(height: 8),
                Row(
                  children: [
                    const Icon(
                      Icons.location_on,
                      color: Colors.grey,
                    ),
                    const SizedBox(width: 8),
                    Expanded(
                      child: Text(
                        churchData['address'],
                        style: const TextStyle(fontSize: 16),
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 16),
              ],
              if (churchData['phone']?.isNotEmpty == true) ...[
                const Text(
                  'Contact',
                  style: TextStyle(
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                const SizedBox(height: 8),
                Row(
                  children: [
                    const Icon(
                      Icons.phone,
                      color: Colors.grey,
                    ),
                    const SizedBox(width: 8),
                    Text(
                      churchData['phone'],
                      style: const TextStyle(fontSize: 16),
                    ),
                  ],
                ),
                const SizedBox(height: 16),
              ],
              if (churchData['website']?.isNotEmpty == true) ...[
                Row(
                  children: [
                    const Icon(
                      Icons.web,
                      color: Colors.grey,
                    ),
                    const SizedBox(width: 8),
                    Text(
                      churchData['website'],
                      style: const TextStyle(fontSize: 16),
                    ),
                  ],
                ),
                const SizedBox(height: 16),
              ],
              Text(
                'Members: ${churchData['memberCount'] ?? 0}',
                style: const TextStyle(
                  fontSize: 16,
                  fontWeight: FontWeight.w500,
                ),
              ),
              const SizedBox(height: 24),
              Row(
                children: [
                  Expanded(
                    child: ElevatedButton(
                      onPressed: () {
                        Navigator.of(context).pop();
                        final isUserMember = userInfo['churchId'] == churchId;
                        if (isUserMember) {
                          _navigateToChurchChat(context, churchId, churchData);
                        } else {
                          _joinChurch(context, churchId, churchData);
                        }
                      },
                      style: ElevatedButton.styleFrom(
                        backgroundColor: userInfo['churchId'] == churchId
                            ? const Color(0xFF1E3A8A)
                            : Colors.green,
                        foregroundColor: Colors.white,
                        padding: const EdgeInsets.symmetric(vertical: 16),
                      ),
                      child: Text(userInfo['churchId'] == churchId
                          ? 'Open Church Chat'
                          : 'Join This Church'),
                    ),
                  ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }

  void _joinChurch(BuildContext context, String churchId,
      Map<String, dynamic> churchData) async {
    try {
      final churchService = ChurchService();
      await churchService.joinChurch(churchId);

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Successfully joined ${churchData['churchName']}!'),
          backgroundColor: Colors.green,
        ),
      );

      // Update user info to reflect the new church membership
      userInfo['churchId'] = churchId;
      userInfo['churchName'] = churchData['churchName'] ?? '';

      close(context, churchData['churchName'] ?? '');
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Error joining church: $e'),
          backgroundColor: Colors.red,
        ),
      );
    }
  }

  void _navigateToChurchChat(
      BuildContext context, String churchId, Map<String, dynamic> churchData) {
    Navigator.of(context).push(
      MaterialPageRoute(
        builder: (context) => ChurchGroupChatPage(
          churchId: churchId,
          churchName: churchData['churchName'] ?? 'Church',
        ),
      ),
    );
    close(context, churchData['churchName'] ?? '');
  }
}
