rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Posts collection - allow authenticated users (including anonymous) to read/write
    match /posts/{postId} {
      allow read, write: if request.auth != null;
      // Allow subcollections (likes, comments)
      match /likes/{userId} {
        allow read, write: if request.auth != null;
      }
      match /comments/{commentId} {
        allow read, write: if request.auth != null;
      }
    }

    // Stories collection - allow authenticated users to read/write
    match /stories/{storyId} {
      allow read, write: if request.auth != null;
    }

    // Users collection - allow authenticated users to read/write (needed for follow functionality)
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // Notifications collection - allow authenticated users to read/write
    match /notifications/{notificationId} {
      allow read, write: if request.auth != null;
    }

    // Churches collection - allow authenticated users to read/write
    match /churches/{churchId} {
      allow read, write: if request.auth != null;
    }

    // Invitations collection - allow authenticated users to read/write
    match /invitations/{invitationId} {
      allow read, write: if request.auth != null;
    }

    // Chats collection - allow authenticated users to read/write
    match /chats/{chatId} {
      allow read, write: if request.auth != null;
      // Allow messages subcollection
      match /messages/{messageId} {
        allow read, write: if request.auth != null;
      }
      match /typing/{userId} {
        allow read, write: if request.auth != null;
      }
    }

    // Groups collection - allow authenticated users to read/write
    match /groups/{groupId} {
      allow read, write: if request.auth != null;
      // Allow messages subcollection
      match /messages/{messageId} {
        allow read, write: if request.auth != null;
      }
    }

    // Community posts collection - allow authenticated users to read/write
    match /community_posts/{postId} {
      allow read, write: if request.auth != null;
    }

    // Content collections
    match /prayers/{prayerId} {
      allow read, write: if request.auth != null;
    }

    match /videos/{videoId} {
      allow read, write: if request.auth != null;
    }

    match /events/{eventId} {
      allow read, write: if request.auth != null;
    }

    // Songs collection - allow authenticated users to read, uploader to write/delete
    match /songs/{songId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == resource.data.uploaderId;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.uploaderId;
    }

    // Curated gospel songs collection - allow authenticated users to read, allow creation for authenticated users
    match /curated_songs/{songId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null &&
        (request.auth.token.admin == true || request.auth.token.email_verified == true);
    }

    // Calls collection - allow authenticated users to read/write for WebRTC calls
    match /calls/{callId} {
      allow read, write: if request.auth != null;
    }

    // Reports collection
    match /reports/{reportId} {
      allow read, write: if request.auth != null;
    }

    // Verses collection - allow authenticated users to read/write
    match /verses/{verseId} {
      allow read, write: if request.auth != null;
    }

    // Donations collection - allow authenticated users to read/write
    match /donations/{donationId} {
      allow read, write: if request.auth != null;
    }

    // Bible-related collections - allow authenticated users to read/write
    match /bookmarks/{bookmarkId} {
      allow read, write: if request.auth != null;
    }

    match /notes/{noteId} {
      allow read, write: if request.auth != null;
    }

    match /highlights/{highlightId} {
      allow read, write: if request.auth != null;
    }

    match /user_preferences/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    match /recent_verses/{verseId} {
      allow read, write: if request.auth != null;
    }
  }
}
